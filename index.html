<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èª²å ‚æª¢æ ¸å¿«é€Ÿå·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .tool-btn { transition: all 0.2s; }
        .tool-btn:active { transform: scale(0.98); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Canvas ç¹ªåœ–é˜²æ­¢æ»¾å‹• */
        canvas { touch-action: none; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

    <nav class="bg-white border-b px-4 py-3 flex justify-between items-center sticky top-0 z-50 shadow-sm h-16">
        <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="resetApp()">
            <div class="bg-blue-600 text-white p-2 rounded-lg font-bold text-xl h-10 w-10 flex items-center justify-center">A</div>
            <h1 class="text-lg md:text-xl font-bold text-gray-700 hidden sm:block">èª²å ‚æª¢æ ¸</h1>
        </div>
        
        <div class="flex items-center gap-3">
            <div id="connection-status" class="hidden md:flex items-center gap-2 text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">
                <span class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></span> é€£ç·šä¸­...
            </div>

            <div id="teacher-nav-controls" class="hidden flex items-center gap-2">
                <button onclick="toggleQR()" class="bg-gray-700 text-white px-3 py-1.5 rounded-lg text-sm font-bold hover:bg-gray-600 transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 4a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1V4zm2 2V5h1v1H5zM3 13a1 1 0 011-1h3a1 1 0 011 1v3a1 1 0 01-1 1H4a1 1 0 01-1-1v-3zm2 2v-1h1v1H5zM13 3a1 1 0 00-1 1v3a1 1 0 001 1h3a1 1 0 001-1V4a1 1 0 00-1-1h-3zm1 2v1h1V5h-1z" clip-rule="evenodd" /></svg>
                    <span id="nav-room-code" class="font-mono text-yellow-400 text-lg tracking-wider">----</span>
                </button>
                <div class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">æ•™å¸«ç«¯</div>
            </div>

            <button id="btn-teacher-login" onclick="attemptTeacherLogin()" class="text-sm font-bold text-gray-500 hover:text-blue-600 px-2 py-1 border border-transparent hover:border-blue-100 rounded transition">
                æ•™å¸«ç™»å…¥
            </button>
        </div>
    </nav>

    <main class="flex-grow container mx-auto p-4 max-w-6xl relative">

        <div id="student-login-view" class="w-full max-w-md mx-auto mt-8 fade-in">
            <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg border border-gray-100">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">åŠ å…¥èª²å ‚äº’å‹•</h2>
                    <p class="text-gray-500 text-sm mt-1">è«‹è¼¸å…¥æ•™å®¤ä»£ç¢¼èˆ‡æ‚¨çš„åº§è™Ÿ</p>
                </div>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">æ•™å®¤ä»£ç¢¼ (Code)</label>
                        <input type="text" id="join-code" class="w-full text-center text-4xl font-mono font-bold tracking-[0.2em] border-2 border-gray-200 rounded-xl p-3 bg-gray-50 focus:border-blue-500 focus:bg-white outline-none uppercase placeholder-gray-300 transition" maxlength="4" placeholder="----">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">æ‚¨çš„åº§è™Ÿ/å§“å</label>
                        <input type="text" id="join-seat" class="w-full text-center text-xl border-2 border-gray-200 rounded-xl p-3 bg-gray-50 focus:border-blue-500 focus:bg-white outline-none transition" placeholder="ä¾‹å¦‚: 05">
                    </div>
                    <button onclick="studentLogin()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl text-lg hover:bg-blue-700 transition shadow-md active:scale-[0.98]">
                        é€²å…¥æ•™å®¤
                    </button>
                </div>
            </div>
        </div>

        <div id="student-workspace" class="hidden w-full max-w-md mx-auto fade-in">
            
            <div class="flex justify-between items-center mb-4 bg-white p-3 rounded-lg shadow-sm">
                <span class="text-gray-500 text-sm">æ•™å®¤: <span id="ws-room-code" class="font-mono font-bold text-black">----</span></span>
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-bold">æˆ‘æ˜¯ <span id="student-seat-display">--</span></span>
            </div>

            <div id="student-waiting" class="text-center mt-12">
                <div class="inline-block p-5 rounded-full bg-white shadow-md mb-6 animate-bounce">
                    <svg class="w-12 h-12 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                </div>
                <h3 class="text-xl font-bold text-gray-700">ç­‰å¾…è€å¸«æŒ‡ä»¤...</h3>
                <p class="text-gray-400 text-sm mt-2">è«‹çœ‹å‰æ–¹å¤§è¢å¹•</p>
            </div>

            <div id="student-active-tool" class="hidden mt-2">
                <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-blue-50">
                    <div class="flex items-center gap-2 mb-4 border-b pb-3">
                        <span class="w-2 h-6 bg-blue-600 rounded-full"></span>
                        <h3 id="student-tool-title" class="text-lg font-bold text-gray-800">äº’å‹•é¡Œç›®</h3>
                    </div>
                    
                    <div id="student-tool-content" class="min-h-[150px]"></div>
                </div>
            </div>
        </div>

        <div id="teacher-view" class="hidden flex flex-col gap-6 fade-in">
            
            <div id="tool-menu" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="text-gray-400 font-bold text-xs mb-4 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-500 rounded-full"></span> å­¸ç”Ÿè‡ªè©• (Assessment As Learning)
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        <button onclick="activateTool('selfAssess')" class="tool-btn bg-white hover:bg-blue-50 text-gray-700 hover:text-blue-700 p-4 rounded-xl font-bold text-left border border-gray-200 hover:border-blue-300 shadow-sm">
                            <span class="text-xl block mb-1">ğŸ“Š</span> è‡ªæˆ‘è©•é‡é‡è¡¨
                            <span class="block text-xs font-normal text-gray-400 mt-1">å››éšæ®µèªçŸ¥æª¢æ ¸</span>
                        </button>
                        <button onclick="activateTool('reflection321')" class="tool-btn bg-white hover:bg-blue-50 text-gray-700 hover:text-blue-700 p-4 rounded-xl font-bold text-left border border-gray-200 hover:border-blue-300 shadow-sm">
                            <span class="text-xl block mb-1">ğŸ’¡</span> 3-2-1 åæ€
                            <span class="block text-xs font-normal text-gray-400 mt-1">æ”¶æ–‚å­¸ç¿’é‡é»</span>
                        </button>
                        <button onclick="activateTool('oneSentence')" class="tool-btn bg-white hover:bg-blue-50 text-gray-700 hover:text-blue-700 p-4 rounded-xl font-bold text-left border border-gray-200 hover:border-blue-300 shadow-sm">
                            <span class="text-xl block mb-1">ğŸ“</span> ä¸€å¥è©±ç†è§£
                            <span class="block text-xs font-normal text-gray-400 mt-1">20-50å­—æ‘˜è¦</span>
                        </button>
                    </div>
                </div>

                <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                    <h2 class="text-gray-400 font-bold text-xs mb-4 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full"></span> èª²å ‚æª¢æ ¸ (Assessment For Learning)
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                        <button onclick="activateTool('fistFive')" class="tool-btn bg-white hover:bg-green-50 text-gray-700 hover:text-green-700 p-4 rounded-xl font-bold text-left border border-gray-200 hover:border-green-300 shadow-sm">
                            <span class="text-xl block mb-1">ğŸ–ï¸</span> å¾ä¸€åˆ°äº”
                            <span class="block text-xs font-normal text-gray-400 mt-1">å¿«é€Ÿç†è§£èª¿æŸ¥</span>
                        </button>
                        <button onclick="activateTool('whiteboard')" class="tool-btn bg-white hover:bg-green-50 text-gray-700 hover:text-green-700 p-4 rounded-xl font-bold text-left border border-gray-200 hover:border-green-300 shadow-sm">
                            <span class="text-xl block mb-1">â¬œ</span> å°ç™½æ¿
                            <span class="block text-xs font-normal text-gray-400 mt-1">æ–‡å­— / ç¹ªåœ–</span>
                        </button>
                        <button onclick="setupPoll()" class="tool-btn bg-white hover:bg-green-50 text-gray-700 hover:text-green-700 p-4 rounded-xl font-bold text-left border border-gray-200 hover:border-green-300 shadow-sm">
                            <span class="text-xl block mb-1">ğŸ—³ï¸</span> å³æ™‚æŠ•ç¥¨
                            <span class="block text-xs font-normal text-gray-400 mt-1">è‡ªè¨‚é¸é … ABCD</span>
                        </button>
                        <button onclick="activateTool('trafficLight')" class="tool-btn bg-white hover:bg-green-50 text-gray-700 hover:text-green-700 p-4 rounded-xl font-bold text-left border border-gray-200 hover:border-green-300 shadow-sm">
                            <span class="text-xl block mb-1">ğŸš¦</span> ç´…ç¶ ç‡ˆ
                            <span class="block text-xs font-normal text-gray-400 mt-1">å³æ™‚æ±‚åŠ©è¨Šè™Ÿ</span>
                        </button>
                        <button onclick="activateTool('numberLine')" class="tool-btn bg-white hover:bg-green-50 text-gray-700 hover:text-green-700 p-4 rounded-xl font-bold text-left border border-gray-200 hover:border-green-300 shadow-sm">
                            <span class="text-xl block mb-1">ğŸ“</span> æ•¸ç·šåˆ†å¸ƒ
                            <span class="block text-xs font-normal text-gray-400 mt-1">1-10 ä¿¡å¿ƒåº¦</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="live-dashboard" class="hidden rounded-2xl flex flex-col overflow-hidden min-h-[600px] fade-in space-y-4">
                
                <div class="bg-white px-6 py-4 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4">
                    <div class="flex items-center gap-4">
                        <button onclick="stopActivity()" class="text-gray-500 hover:text-gray-800 transition bg-gray-100 p-2 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                        </button>
                        <div>
                            <h2 id="current-tool-name" class="text-xl font-bold text-gray-800">æ´»å‹•åç¨±</h2>
                            <div class="flex gap-2 items-center">
                                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                                <span class="text-sm text-gray-500 font-bold">é€²è¡Œä¸­</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="clearResponses()" class="bg-white border hover:bg-red-50 text-red-500 border-red-200 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-1 shadow-sm transition">
                            ğŸ—‘ï¸ æ¸…é™¤
                        </button>
                        <button onclick="exportCSV()" class="bg-white border hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-1 shadow-sm transition">
                            â¬‡ ä¸‹è¼‰ CSV
                        </button>
                        <button onclick="stopActivity()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-md transition flex items-center gap-2">
                            <span>â– </span> çµæŸä¸¦è¿”å›
                        </button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-blue-100">
                    <div class="flex items-center justify-between mb-4 border-b border-gray-100 pb-2">
                        <div class="flex items-center gap-2">
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">æ•™å¸«ç¤ºç¯„å€</span>
                        </div>
                    </div>
                    <div id="teacher-demo-content" class="max-w-xl mx-auto">
                        </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-5/12 flex flex-col">
                        <h3 class="font-bold text-gray-700 mb-2 flex justify-between">
                            <span>å³æ™‚çµ±è¨ˆ</span>
                            <span id="response-count" class="text-sm bg-gray-100 px-2 py-0.5 rounded text-gray-600">å·²å›æ‡‰ï¼š0</span>
                        </h3>
                        <div id="chart-container" class="w-full h-64 relative bg-gray-50 rounded-xl border border-gray-100 p-2">
                            <canvas id="resultChart"></canvas>
                        </div>
                    </div>

                    <div id="list-container" class="w-full md:w-7/12 flex flex-col">
                        <h3 class="font-bold text-gray-700 mb-2">è©³ç´°å›è¦†</h3>
                        <div class="flex-grow overflow-y-auto max-h-[500px] no-scrollbar pr-2 bg-gray-50 rounded-xl border border-gray-100 p-2">
                            <div id="response-list" class="grid grid-cols-1 gap-3"></div>
                        </div>
                    </div>
                </div>

            </div>
        </div>

    </main>

    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center p-4 backdrop-blur-sm" onclick="closeLoginModal()">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm shadow-2xl transform transition-all scale-100" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">æ•™å¸«ç™»å…¥</h3>
                <button onclick="closeLoginModal()" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <p class="text-sm text-gray-500 mb-3">è«‹è¼¸å…¥æ•™å¸«å°ˆç”¨å¯†ç¢¼</p>
            <input type="password" id="teacher-pwd-input" class="w-full p-3 border rounded-xl mb-4 bg-gray-50 focus:bg-white focus:border-blue-500 outline-none transition" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            <div class="flex gap-3 justify-end">
                <button onclick="closeLoginModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition">å–æ¶ˆ</button>
                <button onclick="submitTeacherLogin()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md transition">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <div id="qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4 backdrop-blur-sm" onclick="toggleQR()">
        <div class="bg-white p-6 rounded-2xl flex flex-col items-center max-w-xs w-full shadow-2xl animate-fade" onclick="event.stopPropagation()">
            <h3 class="text-lg font-bold mb-2 text-gray-700">åŠ å…¥ä»£ç¢¼</h3>
            <p id="modal-room-code" class="text-4xl font-mono font-bold text-blue-600 tracking-widest mb-4">----</p>
            <div id="qrcode" class="border-4 border-white shadow-md rounded-lg mb-4 bg-white"></div>
            
            <p class="text-blue-600 font-bold text-lg mb-2">å·²åŠ å…¥äººæ•¸ï¼š<span id="qr-student-count">0</span> äºº</p>

            <p class="text-gray-400 text-xs mt-1">è«‹å­¸ç”Ÿæƒææˆ–è¼¸å…¥ä»£ç¢¼</p>
            <button onclick="toggleQR()" class="mt-4 text-sm text-gray-400 hover:text-gray-600 py-2 w-full border-t">é—œé–‰è¦–çª—</button>
        </div>
    </div>

    <div id="poll-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-md shadow-2xl">
            <h3 class="text-xl font-bold mb-4">è¨­å®šæŠ•ç¥¨é¸é …</h3>
            
            <div class="mb-4">
                <label class="block text-sm font-bold text-gray-600 mb-1">é¡Œç›® (é¸å¡«)</label>
                <input type="text" id="poll-question" class="w-full p-2 border rounded-lg bg-gray-50 focus:bg-white transition outline-none focus:border-blue-500" placeholder="ä¾‹å¦‚ï¼šå“ªä¸€å€‹ä¸æ˜¯å¤ªé™½ç³»è¡Œæ˜Ÿï¼Ÿ">
            </div>

            <p class="text-sm text-gray-500 mb-4">è«‹è¼¸å…¥é¸é …å…§å®¹ï¼š</p>
            
            <div class="space-y-3 mb-6">
                <div class="flex items-center gap-2">
                    <span class="font-bold text-gray-500 w-4">A</span>
                    <input type="text" id="poll-opt-0" class="flex-grow p-2 border rounded-lg bg-gray-50 focus:bg-white transition outline-none focus:border-blue-500" placeholder="é¸é … A" value="é¸é … A">
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-gray-500 w-4">B</span>
                    <input type="text" id="poll-opt-1" class="flex-grow p-2 border rounded-lg bg-gray-50 focus:bg-white transition outline-none focus:border-blue-500" placeholder="é¸é … B" value="é¸é … B">
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-gray-500 w-4">C</span>
                    <input type="text" id="poll-opt-2" class="flex-grow p-2 border rounded-lg bg-gray-50 focus:bg-white transition outline-none focus:border-blue-500" placeholder="é¸é … C" value="é¸é … C">
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-gray-500 w-4">D</span>
                    <input type="text" id="poll-opt-3" class="flex-grow p-2 border rounded-lg bg-gray-50 focus:bg-white transition outline-none focus:border-blue-500" placeholder="é¸é … D" value="é¸é … D">
                </div>
            </div>

            <div class="flex gap-3 justify-end">
                <button onclick="document.getElementById('poll-modal').classList.add('hidden')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="startPoll()" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md">é–‹å§‹æŠ•ç¥¨</button>
            </div>
        </div>
    </div>

    <div id="view-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-[100] flex items-center justify-center p-4 backdrop-blur-sm" onclick="this.classList.add('hidden')">
        <div class="bg-white p-8 rounded-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto shadow-2xl" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <span id="view-seat" class="font-bold text-xl text-blue-600"></span>
                <button onclick="document.getElementById('view-modal').classList.add('hidden')" class="text-gray-400 text-2xl hover:text-red-500">&times;</button>
            </div>
            <div id="view-content" class="text-lg leading-relaxed whitespace-pre-wrap text-gray-800 break-words"></div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="custom-modal" class="hidden fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 transform transition-all scale-100">
            <h3 id="custom-modal-title" class="text-xl font-bold mb-2 text-gray-800">æç¤º</h3>
            <p id="custom-modal-msg" class="text-gray-600 mb-6 whitespace-pre-wrap"></p>
            <div id="custom-modal-actions" class="flex justify-end gap-3">
                <!-- Buttons will be injected here -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, where, serverTimestamp, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Config ---
        const userProvidedConfig = {
            apiKey: "AIzaSyDhVIfEev0PhNHlBKL0vAeQy3jwJOsyVFs",
            authDomain: "myassessmenttool.firebaseapp.com",
            projectId: "myassessmenttool",
            storageBucket: "myassessmenttool.firebasestorage.app",
            messagingSenderId: "165443894580",
            appId: "1:165443894580:web:16a2d9731f30fd6e107961"
        };

        // Use environment config if available (Preview Env), otherwise user config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userProvidedConfig;
        
        // Use environment appId for paths if available, otherwise fallback string
        const appId = typeof __app_id !== 'undefined' ? __app_id : "myassessmenttool";

        // --- Init ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- State ---
        let currentRoomId = null;
        let mySeat = '';
        let chartInstance = null;
        let currentToolData = [];
        let unsubscribeResponses = null;
        let unsubscribeRoom = null;
        let unsubscribeMyResponse = null; 
        let unsubscribeStudentCount = null;
        let isTeacher = false;
        let isInitialized = false;

        const TOOLS = {
            'selfAssess': { name: 'è‡ªæˆ‘è©•é‡é‡è¡¨', type: 'chart' },
            'reflection321': { name: '3-2-1 å­¸ç¿’åæ€', type: 'text' },
            'oneSentence': { name: 'ä¸€å¥è©±ç†è§£', type: 'text' },
            'fistFive': { name: 'å¾ä¸€åˆ°äº”', type: 'chart' },
            'whiteboard': { name: 'å°ç™½æ¿', type: 'text' },
            'poll': { name: 'å³æ™‚æŠ•ç¥¨', type: 'chart' },
            'trafficLight': { name: 'ç´…ç¶ ç‡ˆ', type: 'chart' },
            'numberLine': { name: 'æ•¸ç·šåˆ†å¸ƒ', type: 'chart' }
        };

        // --- Modal Helpers (Replaces Alert/Confirm) ---
        window.showModal = (title, msg, onConfirm, onCancel, confirmText = 'ç¢ºå®š', cancelText = 'å–æ¶ˆ') => {
            const modal = document.getElementById('custom-modal');
            const titleEl = document.getElementById('custom-modal-title');
            const msgEl = document.getElementById('custom-modal-msg');
            const actionsEl = document.getElementById('custom-modal-actions');

            titleEl.innerText = title;
            msgEl.innerText = msg;
            actionsEl.innerHTML = '';

            if (onCancel || cancelText) {
                const cancelBtn = document.createElement('button');
                cancelBtn.className = "px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition font-medium";
                cancelBtn.innerText = cancelText || 'å–æ¶ˆ';
                cancelBtn.onclick = () => {
                    modal.classList.add('hidden');
                    if (onCancel) onCancel();
                };
                actionsEl.appendChild(cancelBtn);
            }

            const confirmBtn = document.createElement('button');
            confirmBtn.className = "px-4 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow-md transition";
            confirmBtn.innerText = confirmText;
            confirmBtn.onclick = () => {
                modal.classList.add('hidden');
                if (onConfirm) onConfirm();
            };
            actionsEl.appendChild(confirmBtn);

            modal.classList.remove('hidden');
        };

        window.showCustomAlert = (msg, callback) => {
            showModal('æç¤º', msg, callback, null, 'ç¢ºå®š', null);
        };

        window.showCustomConfirm = (title, msg, onYes, onNo) => {
            showModal(title, msg, onYes, onNo, 'ç¢ºå®š', 'å–æ¶ˆ');
        };


        // --- Auth & Startup ---
        async function initAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error", error);
                document.getElementById('connection-status').innerHTML = '<span class="text-red-500">é€£ç·šå¤±æ•—</span>';
            }
        }

        initAuth();

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('connection-status').innerHTML = '<span class="w-2 h-2 rounded-full bg-green-500"></span> å·²é€£ç·š';
                if (!isInitialized) {
                    checkUrlParams();
                    isInitialized = true;
                }
            } else {
                // å¦‚æœæœªç™»å…¥ï¼ˆé€šå¸¸ä¸æ‡‰ç™¼ç”Ÿï¼Œä½†ä»¥é˜²è¬ä¸€ï¼‰ï¼Œé‡æ–°å˜—è©¦
                initAuth(); 
            }
        });

        // --- Soft Reset ---
        window.resetApp = () => {
            if (unsubscribeResponses) unsubscribeResponses();
            if (unsubscribeRoom) unsubscribeRoom();
            if (unsubscribeMyResponse) unsubscribeMyResponse();
            if (unsubscribeStudentCount) unsubscribeStudentCount();
            
            currentRoomId = null;
            mySeat = '';
            currentToolData = [];
            
            document.getElementById('student-login-view').classList.remove('hidden');
            document.getElementById('student-workspace').classList.add('hidden');
            document.getElementById('teacher-view').classList.add('hidden');
            document.getElementById('teacher-nav-controls').classList.add('hidden');
            document.getElementById('btn-teacher-login').classList.remove('hidden');
            
            if (!window.location.search.includes('room')) {
                 document.getElementById('join-code').value = '';
            }
        }

        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const roomParam = params.get('room');
            if (roomParam) {
                document.getElementById('join-code').value = roomParam;
                document.getElementById('join-seat').focus();
            }
            document.getElementById('student-login-view').classList.remove('hidden');
        }

        // --- Teacher Logic ---
        window.attemptTeacherLogin = () => {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('teacher-pwd-input').value = '';
            setTimeout(() => document.getElementById('teacher-pwd-input').focus(), 100);
        };

        window.closeLoginModal = () => document.getElementById('login-modal').classList.add('hidden');

        // æ”¹ç‚º Async ä»¥è™•ç†å¯èƒ½çš„éŒ¯èª¤
        window.submitTeacherLogin = async () => {
            const pwd = document.getElementById('teacher-pwd-input').value;
            if (pwd === 'edu') {
                closeLoginModal();
                try {
                    await initTeacher();
                } catch (e) {
                    console.error(e);
                    showCustomAlert("åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                }
            } else {
                showCustomAlert("å¯†ç¢¼éŒ¯èª¤");
                document.getElementById('teacher-pwd-input').value = '';
                document.getElementById('teacher-pwd-input').focus();
            }
        };

        document.getElementById('teacher-pwd-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitTeacherLogin();
        });

        window.initTeacher = async () => {
            if (!auth.currentUser) await initAuth();
            
            isTeacher = true;
            currentRoomId = generateRoomId();
            
            document.getElementById('student-login-view').classList.add('hidden');
            document.getElementById('teacher-view').classList.remove('hidden');
            document.getElementById('btn-teacher-login').classList.add('hidden');
            document.getElementById('teacher-nav-controls').classList.remove('hidden');
            document.getElementById('nav-room-code').innerText = currentRoomId;
            document.getElementById('modal-room-code').innerText = currentRoomId;

            try {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                await setDoc(roomRef, {
                    activeTool: null,
                    createdAt: serverTimestamp(),
                    createdBy: auth.currentUser.uid
                });

                const joinUrl = window.location.href.split('?')[0] + '?room=' + currentRoomId;
                document.getElementById("qrcode").innerHTML = '';
                new QRCode(document.getElementById("qrcode"), { text: joinUrl, width: 128, height: 128 });
            } catch (e) {
                console.error("Init teacher error:", e);
                // é€™è£¡çš„éŒ¯èª¤å°‡è¢« submitTeacherLogin çš„ catch æ•ç²
                throw e; 
            }
        };

        window.activateTool = async (toolId, config = {}) => {
            if (toolId === 'whiteboard' && !config.mode) {
                 showModal("æ¨¡å¼é¸æ“‡", "è«‹é¸æ“‡å­¸ç”Ÿä½œç­”çš„æ–¹å¼ï¼š", 
                    () => {
                        config.mode = 'draw';
                        proceedActivateTool(toolId, config);
                    }, 
                    () => {
                        config.mode = 'text';
                        proceedActivateTool(toolId, config);
                    },
                    "ç¹ªç•«æ¨¡å¼",
                    "æ–‡å­—æ¨¡å¼"
                );
                return;
            }
            proceedActivateTool(toolId, config);
        };

        async function proceedActivateTool(toolId, config) {
            // Optimistic UI: ç«‹å³åˆ‡æ›ä»‹é¢ï¼Œä¸ç”¨ç­‰ DB å›æ‡‰
            if (unsubscribeResponses) unsubscribeResponses();

            document.getElementById('tool-menu').classList.add('hidden');
            document.getElementById('live-dashboard').classList.remove('hidden');
            document.getElementById('current-tool-name').innerText = TOOLS[toolId].name;
            document.getElementById('response-list').innerHTML = '';
            document.getElementById('response-count').innerText = 'å·²å›æ‡‰ï¼š0 äºº';

            renderToolUI(document.getElementById('teacher-demo-content'), toolId, config, true);

            const chartBox = document.getElementById('chart-container');
            if (TOOLS[toolId].type === 'chart') {
                chartBox.parentElement.classList.remove('hidden');
            } else {
                chartBox.parentElement.classList.add('hidden');
            }
            
            try {
                // èƒŒæ™¯åŸ·è¡Œ Firebase æ›´æ–°
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                await updateDoc(roomRef, { activeTool: toolId, toolConfig: config, timestamp: serverTimestamp() });

                // å•Ÿå‹•ç›£è½
                const respRef = collection(db, 'artifacts', appId, 'public', 'data', 'responses');
                const q = query(respRef, where('roomId', '==', currentRoomId));
                
                unsubscribeResponses = onSnapshot(q, (snapshot) => {
                    let data = snapshot.docs.map(d => d.data());
                    data = data.filter(d => d.toolId === toolId);
                    data.sort((a,b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
                    
                    currentToolData = data;
                    document.getElementById('response-count').innerText = `å·²å›æ‡‰ï¼š${data.length}`;
                    renderResults(toolId, data);
                }, (error) => {
                    console.error("Responses snapshot error:", error);
                });
            } catch (e) {
                console.error("Activate Tool Error:", e);
                showCustomAlert("æ´»å‹•å•Ÿå‹•å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š", () => {
                    // å›å¾© UI
                    document.getElementById('live-dashboard').classList.add('hidden');
                    document.getElementById('tool-menu').classList.remove('hidden');
                });
            }
        }

        window.stopActivity = async (updateDB = true) => {
            if (unsubscribeResponses) unsubscribeResponses();
            if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
            currentToolData = [];
            
            if (updateDB) {
                // Optimistic UI for stopping
                document.getElementById('live-dashboard').classList.add('hidden');
                document.getElementById('tool-menu').classList.remove('hidden');

                try {
                    const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                    await updateDoc(roomRef, { activeTool: null });
                } catch(e) {
                    console.error("Stop Activity Error", e);
                }
            }
        };

        // --- Common Tool Rendering ---
        function renderToolUI(container, toolId, config, isTeacherDemo = false) {
            let html = '';
            
            // å³æ™‚æŠ•ç¥¨é¡¯ç¤ºé¡Œç›®
            if (toolId === 'poll' && config.question) {
                html += `<div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-800 font-bold rounded text-lg">
                    ${config.question}
                </div>`;
            }

            if (toolId === 'selfAssess') {
                html += `<div class="space-y-3">
                    <p class="font-bold mb-2 text-gray-700">å­¸ç¿’ç‹€æ³è‡ªè©•ï¼š</p>
                    ${[{v:1, t:'1. å³ä½¿æœ‰äººå¹«å¿™ï¼Œæˆ‘ä¹Ÿä¸æ˜ç™½'}, {v:2, t:'2. å¦‚æœæœ‰äººå¹«å¿™ï¼Œæˆ‘å°±èƒ½æ˜ç™½'}, {v:3, t:'3. å¤§è‡´ä¸Šäº†è§£ï¼Œä½†æˆ‘éœ€è¦ç·´ç¿’'}, {v:4, t:'4. å·²ç¶“äº†è§£äº†ï¼Œæˆ‘éœ€è¦æ›´å¤šæŒ‘æˆ°'}].map(opt => `
                        <label class="flex items-center p-4 border rounded-xl cursor-pointer hover:bg-blue-50 transition bg-gray-50">
                            <input type="radio" name="sa_level" value="${opt.v}" class="w-5 h-5 text-blue-600">
                            <span class="ml-3 text-sm font-medium text-gray-700">${opt.t}</span>
                        </label>`).join('')}
                    <textarea id="${isTeacherDemo ? 'sa_reason_demo' : 'sa_reason'}" class="w-full mt-3 p-3 border rounded-xl bg-gray-50 focus:bg-white transition outline-none" rows="2" placeholder="åŸå› (å¿…å¡«)..."></textarea>
                </div>`;
            } else if (toolId === 'reflection321') {
                html += `<div class="space-y-4">
                    <div>
                        <label class="font-bold text-blue-600 block mb-1">3 å€‹æˆ‘å­¸ç¿’åˆ°çš„çŸ¥è­˜</label>
                        <div class="space-y-2">
                            <input type="text" id="${isTeacherDemo?'ref_3_0_d':'ref_3_0'}" class="w-full p-2 border rounded-lg bg-gray-50 focus:bg-white" placeholder="1.">
                            <input type="text" id="${isTeacherDemo?'ref_3_1_d':'ref_3_1'}" class="w-full p-2 border rounded-lg bg-gray-50 focus:bg-white" placeholder="2.">
                            <input type="text" id="${isTeacherDemo?'ref_3_2_d':'ref_3_2'}" class="w-full p-2 border rounded-lg bg-gray-50 focus:bg-white" placeholder="3.">
                        </div>
                    </div>
                    <div>
                        <label class="font-bold text-green-600 block mb-1">2 å€‹æˆ‘è¦ºå¾—æœ‰è¶£æˆ–é‡è¦çš„åœ°æ–¹</label>
                        <div class="space-y-2">
                            <input type="text" id="${isTeacherDemo?'ref_2_0_d':'ref_2_0'}" class="w-full p-2 border rounded-lg bg-gray-50 focus:bg-white" placeholder="1.">
                            <input type="text" id="${isTeacherDemo?'ref_2_1_d':'ref_2_1'}" class="w-full p-2 border rounded-lg bg-gray-50 focus:bg-white" placeholder="2.">
                        </div>
                    </div>
                    <div>
                        <label class="font-bold text-red-600 block mb-1">1 å€‹ä»æœ‰ç–‘å•æˆ–æƒ³è¦æ¢ç´¢çš„å•é¡Œ</label>
                        <input type="text" id="${isTeacherDemo?'ref_1_d':'ref_1'}" class="w-full p-3 border rounded-xl bg-gray-50 focus:bg-white" placeholder="æˆ‘ä¸æ‡‚...">
                    </div>
                </div>`;
            } else if (toolId === 'oneSentence') {
                html += `<p class="mb-2 text-gray-700 font-bold">è«‹ç”¨ä¸€åˆ°å…©å¥è©±èªªæ˜ä»Šæ—¥æ‰€å­¸</p>
                    <p class="mb-2 text-gray-500 text-xs">å­—æ•¸é™åˆ¶ï¼š20 ~ 50 å­—</p>
                    <textarea id="${isTeacherDemo?'os_text_d':'os_text'}" class="w-full p-3 border-2 rounded-xl h-40 focus:border-blue-500 outline-none text-lg" oninput="checkLen(this)" placeholder="è«‹è¼¸å…¥..."></textarea>
                    <div class="text-right text-sm mt-1"><span id="char-cnt" class="text-red-500 font-bold">0</span> / 50</div>`;
            } else if (toolId === 'fistFive') {
                html += `<p class="text-gray-500 text-center text-sm mb-4">(1ä»£è¡¨éå¸¸ä¸ç†è§£ï¼Œ5ä»£è¡¨éå¸¸ç†è§£)</p>
                <div class="flex justify-center gap-3 py-4">
                    ${[1,2,3,4,5].map(n => `<button type="button" onclick="selectBtn(this, '${n}')" class="sel-btn w-14 h-14 rounded-full border-2 text-2xl font-bold hover:bg-green-100 transition bg-white shadow-sm">${n}</button>`).join('')}
                </div><input type="hidden" id="ans_val">`;
            } else if (toolId === 'whiteboard') {
                // å°ç™½æ¿æ ¹æ“šæ¨¡å¼æ¸²æŸ“
                if (config.mode === 'draw') {
                    const canvasId = isTeacherDemo ? 'wb_canvas_d' : 'wb_canvas';
                    html += `<div class="border-2 border-dashed border-gray-300 rounded-xl bg-white overflow-hidden touch-none relative">
                        <canvas id="${canvasId}" class="w-full h-[300px] cursor-crosshair block" width="600" height="600"></canvas>
                        <div class="absolute top-2 right-2 flex gap-2">
                            <button type="button" onclick="clearCanvas('${canvasId}')" class="bg-white/80 p-2 rounded-lg shadow text-xs font-bold border hover:bg-red-50 text-red-500">æ¸…é™¤é‡ç•«</button>
                        </div>
                    </div>
                    <p class="text-center text-xs text-gray-400 mt-2">è«‹åœ¨ä¸Šæ–¹æ¡†æ¡†å…§ç¹ªç•«</p>`;
                    setTimeout(() => initCanvas(canvasId), 100);
                } else {
                    html += `<textarea id="${isTeacherDemo?'wb_text_d':'wb_text'}" class="w-full p-4 border-2 rounded-xl h-48 text-lg bg-gray-50 focus:bg-white outline-none" placeholder="è«‹åœ¨æ­¤ä½œç­”..."></textarea>`;
                }
            } else if (toolId === 'poll') {
                const opts = config.options || ['A','B','C','D'];
                html += `<div class="grid grid-cols-2 gap-3">
                    ${opts.map(o => `<button type="button" onclick="selectBtn(this, '${o}')" class="sel-btn p-5 border-2 rounded-2xl text-xl font-bold hover:bg-blue-50 transition break-words bg-white shadow-sm">${o}</button>`).join('')}
                </div><input type="hidden" id="ans_val">`;
            } else if (toolId === 'trafficLight') {
                html += `<div class="space-y-3">
                    <button type="button" onclick="selectBtn(this, 'Green')" class="sel-btn w-full p-4 border-2 rounded-xl text-lg font-bold bg-green-50 border-green-200 text-green-700 hover:bg-green-100 transition shadow-sm">ğŸŸ¢ ç¶ ç‡ˆ (æ‡‚äº†)</button>
                    <button type="button" onclick="selectBtn(this, 'Yellow')" class="sel-btn w-full p-4 border-2 rounded-xl text-lg font-bold bg-yellow-50 border-yellow-200 text-yellow-700 hover:bg-yellow-100 transition shadow-sm">ğŸŸ¡ é»ƒç‡ˆ (ä¸ç¢ºå®š)</button>
                    <button type="button" onclick="selectBtn(this, 'Red')" class="sel-btn w-full p-4 border-2 rounded-xl text-lg font-bold bg-red-50 border-red-200 text-red-700 hover:bg-red-100 transition shadow-sm">ğŸ”´ ç´…ç‡ˆ (ä¸æ‡‚)</button>
                </div><input type="hidden" id="ans_val">`;
            } else if (toolId === 'numberLine') {
                html += `<div class="pt-8 pb-2 px-2">
                    <input type="range" id="${isTeacherDemo?'nl_range_d':'nl_range'}" min="1" max="10" value="5" class="w-full h-4 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="this.nextElementSibling.querySelector('.val-disp').innerText = this.value">
                    <div class="flex justify-between mt-8 text-gray-500 font-bold text-sm">
                        <span>1 (æ²’ä¿¡å¿ƒ)</span>
                        <span class="val-disp text-5xl -mt-12 text-blue-600 font-black">5</span>
                        <span>10 (æœ‰ä¿¡å¿ƒ)</span>
                    </div>
                </div>`;
            }

            const btnText = "é€å‡ºç­”æ¡ˆ";
            const btnAction = isTeacherDemo ? "showCustomAlert('é€™æ˜¯ç¤ºç¯„æ¨¡å¼ï¼Œä¸æœƒé€å‡ºè³‡æ–™ã€‚')" : "submitResponse()";
            const btnColor = isTeacherDemo ? "bg-gray-500 hover:bg-gray-600" : "bg-green-600 hover:bg-green-700";
            const btnId = isTeacherDemo ? "btn-submit-demo" : "btn-submit";
            
            html += `<div class="mt-6 pt-4 border-t border-gray-100">
                <button id="${btnId}" onclick="${btnAction}" class="w-full ${btnColor} text-white font-bold py-3.5 rounded-xl transition shadow text-lg">${btnText}</button>
                ${!isTeacherDemo ? '<p id="submit-status" class="text-center text-sm text-gray-400 mt-2 h-5 font-bold"></p>' : ''}
            </div>`;

            container.innerHTML = html;
        }

        window.setupPoll = () => document.getElementById('poll-modal').classList.remove('hidden');
        
        window.startPoll = () => {
            const question = document.getElementById('poll-question').value.trim();
            const inputs = [
                document.getElementById('poll-opt-0').value,
                document.getElementById('poll-opt-1').value,
                document.getElementById('poll-opt-2').value,
                document.getElementById('poll-opt-3').value
            ];
            const options = inputs.map(s => s.trim()).filter(s => s);
            if (options.length < 2) return showCustomAlert('è«‹è‡³å°‘è¼¸å…¥å…©å€‹é¸é …');
            document.getElementById('poll-modal').classList.add('hidden');
            activateTool('poll', { options, question });
        };

        // --- Student Logic ---
        window.studentLogin = async () => {
            const code = document.getElementById('join-code').value.trim().toUpperCase();
            const seat = document.getElementById('join-seat').value.trim();
            if (code.length < 3 || !seat) return showCustomAlert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');

            // ç¢ºä¿å·²ç™»å…¥ï¼Œè‹¥æœªç™»å…¥å‰‡ç­‰å¾…
            if (!auth.currentUser) {
                try {
                    await initAuth();
                } catch(e) {
                    return showCustomAlert("ç„¡æ³•å»ºç«‹é€£ç·š");
                }
            }

            currentRoomId = code;
            mySeat = seat;

            const safeSeat = mySeat.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
            const docId = `${currentRoomId}_${safeSeat}`;
            const studentRef = doc(db, 'artifacts', appId, 'public', 'data', 'students', docId);

            try {
                await setDoc(studentRef, { 
                    roomId: currentRoomId,
                    seat: mySeat, 
                    joinedAt: serverTimestamp() 
                });
            } catch(e) { 
                console.warn("Join stats error (likely permissions, ignoring):", e); 
                // å¿½ç•¥çµ±è¨ˆéŒ¯èª¤ï¼Œè®“å­¸ç”Ÿä»å¯ç¹¼çºŒé€²å…¥
            }

            document.getElementById('student-login-view').classList.add('hidden');
            document.getElementById('student-workspace').classList.remove('hidden');
            
            document.getElementById('ws-room-code').innerText = code;
            document.getElementById('student-seat-display').innerText = seat;

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            unsubscribeRoom = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    handleRoomUpdate(data);
                } else {
                    showCustomAlert('æ‰¾ä¸åˆ°æ­¤æ•™å®¤ä»£ç¢¼', () => resetApp());
                }
            }, (error) => {
                console.error("Room snapshot error:", error);
                showCustomAlert('é€£ç·šç•°å¸¸ï¼Œè«‹ç¢ºèªä»£ç¢¼æ˜¯å¦æ­£ç¢º');
            });
        };

        function handleRoomUpdate(data) {
            const waitingEl = document.getElementById('student-waiting');
            const activeEl = document.getElementById('student-active-tool');
            
            if (!data.activeTool) {
                if (unsubscribeMyResponse) unsubscribeMyResponse(); 
                waitingEl.classList.remove('hidden');
                activeEl.classList.add('hidden');
                document.getElementById('student-tool-content').innerHTML = '';
            } else {
                waitingEl.classList.add('hidden');
                activeEl.classList.remove('hidden');
                renderToolUI(document.getElementById('student-tool-content'), data.activeTool, data.toolConfig, false);
                
                const safeSeat = mySeat.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                const docId = `${currentRoomId}_${data.activeTool}_${safeSeat}`;
                const myRef = doc(db, 'artifacts', appId, 'public', 'data', 'responses', docId);
                
                if (unsubscribeMyResponse) unsubscribeMyResponse();
                unsubscribeMyResponse = onSnapshot(myRef, (docSnap) => {
                    const btn = document.getElementById('btn-submit');
                    if (btn) {
                        if (docSnap.exists()) {
                            btn.innerText = "æ›´æ–°ç­”æ¡ˆ";
                            btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                        } else {
                            btn.innerText = "é€å‡ºç­”æ¡ˆ";
                            btn.classList.add('bg-green-600', 'hover:bg-green-700');
                            btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        }
                    }
                }, (error) => {
                    console.error("My response snapshot error:", error);
                });
            }
        }

        // --- Shared Logic ---
        window.selectBtn = (el, val) => {
            const container = el.closest('div').parentElement; 
            container.querySelectorAll('.sel-btn').forEach(b => b.classList.remove('ring-4', 'ring-offset-2', 'ring-blue-400', 'border-blue-600', 'scale-110'));
            el.classList.add('ring-4', 'ring-offset-2', 'ring-blue-400', 'border-blue-600', 'scale-110');
            container.querySelector('input[type="hidden"]').value = val;
        };

        window.checkLen = (el) => {
            const len = el.value.length;
            const cnt = el.parentElement.querySelector('#char-cnt');
            cnt.innerText = len;
            cnt.className = (len >= 20 && len <= 50) ? 'text-green-600 font-bold' : 'text-red-500 font-bold';
        };

        // --- Canvas Helpers ---
        window.initCanvas = (id) => {
            const canvas = document.getElementById(id);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            const rect = canvas.getBoundingClientRect();
            canvas.width = rect.width;
            canvas.height = rect.height;

            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const start = (e) => {
                if (e.cancelable) e.preventDefault(); 
                isDrawing = true;
                const pos = getPos(e);
                ctx.beginPath();
                ctx.moveTo(pos.x, pos.y);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                if (e.cancelable) e.preventDefault();
                const pos = getPos(e);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();
            };

            const end = () => { isDrawing = false; };

            canvas.addEventListener('mousedown', start);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', end);
            canvas.addEventListener('mouseleave', end);
            canvas.addEventListener('touchstart', start, {passive: false});
            canvas.addEventListener('touchmove', draw, {passive: false});
            canvas.addEventListener('touchend', end);
        };

        window.clearCanvas = (id) => {
            const canvas = document.getElementById(id);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        };

        window.submitResponse = async () => {
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "å‚³é€ä¸­...";
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
            
            try {
                const roomSnap = await getDoc(roomRef);
                const toolId = roomSnap.data()?.activeTool;

                if (!toolId) return;

                let val = null;
                // ... validation logic omitted for brevity, keeping existing ...
                if (toolId === 'selfAssess') {
                    const el = document.querySelector('input[name="sa_level"]:checked');
                    const reason = document.getElementById('sa_reason').value.trim();
                    if(!el) { resetBtn(); return showCustomAlert('è«‹é¸æ“‡ç¨‹åº¦'); }
                    if(!reason) { resetBtn(); return showCustomAlert('è«‹è¼¸å…¥åŸå› '); }
                    val = { level: el.value, reason: reason };
                } else if (toolId === 'reflection321') {
                    const p3 = [
                        document.getElementById('ref_3_0').value.trim(),
                        document.getElementById('ref_3_1').value.trim(),
                        document.getElementById('ref_3_2').value.trim()
                    ].filter(s => s);
                    const p2 = [
                        document.getElementById('ref_2_0').value.trim(),
                        document.getElementById('ref_2_1').value.trim()
                    ].filter(s => s);
                    const p1 = document.getElementById('ref_1').value.trim();
                    
                    if(p3.length === 0 || p2.length === 0 || !p1) { resetBtn(); return showCustomAlert('è«‹å®Œæ•´å¡«å¯«'); }
                    val = { p3, p2, p1 };
                } else if (toolId === 'oneSentence') {
                    val = document.getElementById('os_text').value;
                    if(val.length < 20 || val.length > 50) { resetBtn(); return showCustomAlert('è«‹ç¬¦åˆå­—æ•¸é™åˆ¶'); }
                } else if (toolId === 'whiteboard') {
                    const textArea = document.getElementById('wb_text');
                    const canvas = document.getElementById('wb_canvas');
                    if (textArea) {
                        val = textArea.value;
                    } else if (canvas) {
                        val = canvas.toDataURL('image/png', 0.5);
                    }
                } else if (toolId === 'numberLine') {
                    val = document.getElementById('nl_range').value;
                } else {
                    val = document.getElementById('ans_val').value;
                    if(!val) { resetBtn(); return showCustomAlert('è«‹é¸æ“‡ä¸€å€‹é¸é …'); }
                }

                const safeSeat = mySeat.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                const docId = `${currentRoomId}_${toolId}_${safeSeat}`;
                const respRef = doc(db, 'artifacts', appId, 'public', 'data', 'responses', docId);
                
                await setDoc(respRef, {
                    roomId: currentRoomId,
                    toolId: toolId,
                    seat: mySeat,
                    value: val,
                    timestamp: serverTimestamp()
                });
                
                document.getElementById('submit-status').innerText = "âœ… å‚³é€æˆåŠŸ";
                btn.disabled = false;
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            } catch (e) {
                console.error(e);
                showCustomAlert("å‚³é€å¤±æ•—ï¼Œè«‹é‡è©¦");
                resetBtn();
            }

            function resetBtn() { 
                btn.innerText = "é€å‡ºç­”æ¡ˆ"; 
                btn.disabled = false; 
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        };

        // --- Utils & Helpers ---
        window.toggleQR = () => {
            const el = document.getElementById('qr-modal');
            el.classList.toggle('hidden');
            
            if (!el.classList.contains('hidden') && currentRoomId) {
                // Flattened structure query
                const studentsRef = collection(db, 'artifacts', appId, 'public', 'data', 'students');
                const q = query(studentsRef, where('roomId', '==', currentRoomId));
                
                if (unsubscribeStudentCount) unsubscribeStudentCount();
                unsubscribeStudentCount = onSnapshot(q, (snap) => {
                    document.getElementById('qr-student-count').innerText = snap.size;
                }, (error) => {
                    console.warn("Student count permission/query error:", error);
                    document.getElementById('qr-student-count').innerText = "?";
                });
            } else {
                if (unsubscribeStudentCount) {
                    unsubscribeStudentCount();
                    unsubscribeStudentCount = null;
                }
            }
        };

        window.generateRoomId = () => {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let res = '';
            for(let i=0; i<4; i++) res += chars.charAt(Math.floor(Math.random() * chars.length));
            return res;
        }
        window.viewDetail = (seat, txt) => {
            document.getElementById('view-seat').innerText = `${seat} çš„å›ç­”`;
            const contentEl = document.getElementById('view-content');
            
            if (txt.startsWith('IMAGE:')) {
                const src = txt.substring(6);
                contentEl.innerHTML = `<img src="${src}" class="w-full rounded border shadow-sm" />`;
            } else {
                contentEl.innerText = txt;
            }
            document.getElementById('view-modal').classList.remove('hidden');
        };
        
        // æ¸…é™¤åŠŸèƒ½
        window.clearResponses = async () => {
            if (!currentRoomId) return;
            if (currentToolData.length === 0) return showCustomAlert("ç›®å‰æ²’æœ‰è³‡æ–™å¯æ¸…é™¤");
            
            showCustomConfirm("è­¦å‘Š", 'ç¢ºå®šè¦æ¸…é™¤ç›®å‰æ‰€æœ‰å­¸ç”Ÿçš„å›æ‡‰å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚', async () => {
                const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', currentRoomId);
                
                try {
                    const roomSnap = await getDoc(roomRef);
                    const activeTool = roomSnap.data()?.activeTool;

                    if (!activeTool) return;

                    const batch = writeBatch(db);
                    currentToolData.forEach(d => {
                        const safeSeat = d.seat.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                        const docId = `${currentRoomId}_${activeTool}_${safeSeat}`;
                        const ref = doc(db, 'artifacts', appId, 'public', 'data', 'responses', docId);
                        batch.delete(ref);
                    });

                    await batch.commit();
                    showCustomAlert("å·²æ¸…é™¤æ‰€æœ‰å›æ‡‰");
                } catch (e) {
                    console.error(e);
                    showCustomAlert("æ¸…é™¤å¤±æ•—ï¼Œè«‹é‡è©¦");
                }
            });
        };

        window.exportCSV = () => {
            if (currentToolData.length === 0) return showCustomAlert('ç„¡è³‡æ–™å¯ä¸‹è¼‰');
            const rows = currentToolData.map(d => {
                let valStr = '';
                if (typeof d.value === 'object') {
                    if (d.value.p3) { 
                        valStr = `çŸ¥è­˜:${d.value.p3.join('/')} | æœ‰è¶£:${d.value.p2.join('/')} | ç–‘å•:${d.value.p1}`;
                    } else if (d.value.level) { 
                        valStr = `L${d.value.level}: ${d.value.reason}`;
                    } else {
                        valStr = JSON.stringify(d.value);
                    }
                } else if (typeof d.value === 'string' && d.value.startsWith('data:image')) {
                    valStr = "[åœ–ç‰‡è³‡æ–™]";
                } else {
                    valStr = d.value;
                }
                valStr = `"${String(valStr).replace(/"/g, '""')}"`;
                return `${d.seat},${valStr},${d.timestamp ? new Date(d.timestamp.seconds*1000).toLocaleTimeString() : ''}`;
            });
            const csvContent = "\uFEFFåº§è™Ÿ,å…§å®¹,æ™‚é–“\n" + rows.join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `Results_${currentRoomId}.csv`;
            link.click();
        };

        function renderResults(toolId, data) {
            const listEl = document.getElementById('response-list');
            listEl.innerHTML = '';
            data.forEach(d => {
                let content = '';
                if (toolId === 'selfAssess') {
                    content = `<span class="font-bold text-blue-600 text-lg">L${d.value.level}</span> <span class="text-gray-600 text-sm ml-2 border-l pl-2">${d.value.reason || ''}</span>`;
                } else if (toolId === 'reflection321') {
                    const p3 = d.value.p3 ? d.value.p3.join('ã€') : '';
                    const p2 = d.value.p2 ? d.value.p2.join('ã€') : '';
                    content = `<div class="text-sm space-y-1">
                        <div class="flex"><span class="text-blue-600 font-bold w-12 shrink-0">3çŸ¥è­˜:</span><span>${p3}</span></div>
                        <div class="flex"><span class="text-green-600 font-bold w-12 shrink-0">2æœ‰è¶£:</span><span>${p2}</span></div>
                        <div class="flex"><span class="text-red-600 font-bold w-12 shrink-0">1ç–‘å•:</span><span>${d.value.p1}</span></div>
                    </div>`;
                } else if (toolId === 'whiteboard' || toolId === 'oneSentence') {
                    if (d.value && d.value.startsWith && d.value.startsWith('data:image')) {
                        content = `<div class="cursor-pointer border rounded bg-gray-50" onclick="window.viewDetail('${d.seat}', 'IMAGE:${d.value}')">
                            <img src="${d.value}" class="max-h-24 mx-auto" />
                        </div>`;
                    } else {
                        content = `<div class="cursor-pointer hover:bg-blue-50 p-2 rounded transition text-gray-700" onclick="window.viewDetail('${d.seat}', this.innerText)">${d.value}</div>`;
                    }
                } else if (toolId === 'trafficLight') {
                    const colorMap = { 'Red': 'ğŸ”´ ç´…', 'Yellow': 'ğŸŸ¡ é»ƒ', 'Green': 'ğŸŸ¢ ç¶ ' };
                    content = `<span class="font-bold text-lg">${colorMap[d.value] || d.value}</span>`;
                } else {
                    content = `<span class="font-mono font-bold text-xl text-indigo-600">${d.value}</span>`;
                }
                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl border border-gray-100 shadow-sm flex items-start gap-3 hover:shadow-md transition";
                div.innerHTML = `<div class="bg-gray-100 text-gray-600 font-bold rounded-lg px-2 py-1.5 text-sm whitespace-nowrap min-w-[3.5rem] text-center">${d.seat}</div><div class="flex-grow break-words pt-1">${content}</div>`;
                listEl.appendChild(div);
            });
            if (TOOLS[toolId].type === 'chart') updateChart(toolId, data);
        }

        function updateChart(toolId, data) {
            const ctx = document.getElementById('resultChart');
            if (!ctx) return;
            let labels = [], counts = [], colors = [];
            if (toolId === 'fistFive') {
                labels = ['1', '2', '3', '4', '5'];
                let map = {1:0, 2:0, 3:0, 4:0, 5:0};
                data.forEach(d => map[d.value] = (map[d.value]||0) + 1);
                counts = Object.values(map);
                colors = '#3b82f6';
            } else if (toolId === 'poll') {
                let map = {};
                data.forEach(d => map[d.value] = (map[d.value] || 0) + 1);
                labels = Object.keys(map).sort();
                counts = labels.map(k => map[k]);
                colors = ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6'];
            } else if (toolId === 'trafficLight') {
                let map = {'Red':0, 'Yellow':0, 'Green':0};
                data.forEach(d => map[d.value] = (map[d.value] || 0) + 1);
                labels = ['ç´…ç‡ˆ', 'é»ƒç‡ˆ', 'ç¶ ç‡ˆ'];
                counts = [map['Red'], map['Yellow'], map['Green']];
                colors = ['#EF4444', '#F59E0B', '#10B981'];
            } else if (toolId === 'selfAssess') {
                 labels = ['L1', 'L2', 'L3', 'L4'];
                 let map = {1:0, 2:0, 3:0, 4:0};
                 data.forEach(d => map[d.value.level] = (map[d.value.level]||0) + 1);
                 counts = Object.values(map);
                 colors = '#8B5CF6';
            } else if (toolId === 'numberLine') {
                labels = Array.from({length:10}, (_,i)=>i+1);
                let map = {};
                data.forEach(d => map[d.value] = (map[d.value]||0) + 1);
                counts = labels.map(l => map[l] || 0);
                colors = '#6366F1';
            }
            if (chartInstance) chartInstance.destroy();
            const isPie = (toolId === 'trafficLight' || toolId === 'poll');
            chartInstance = new Chart(ctx, {
                type: isPie ? 'doughnut' : 'bar',
                data: { labels: labels, datasets: [{ label: 'äººæ•¸', data: counts, backgroundColor: colors, borderWidth: 1, borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: isPie, position: 'right' } }, scales: isPie ? {} : { y: { beginAtZero: true, ticks: { stepSize: 1 } } } }
            });
        }
    </script>
</body>
</html>
