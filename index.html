<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini æ™ºæ…§èª²å ‚äº’å‹• Canvas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; }
        .tool-card { transition: all 0.2s; cursor: pointer; }
        .tool-card:hover { transform: translateY(-3px); box-shadow: 0 8px 15px -3px rgba(0,0,0,0.1); }
        /* Markdown å…§å®¹æ¨£å¼ */
        .markdown-body p { margin-bottom: 1em; line-height: 1.6; }
        .markdown-body h1, .markdown-body h2 { font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col min-h-screen text-gray-800">

    <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50 w-full max-w-sm px-4"></div>

    <nav class="bg-white shadow-sm border-b p-3 sticky top-0 z-40 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-1.5 rounded-lg shadow">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </div>
            <h1 class="text-lg font-bold tracking-wide text-gray-700">Gemini èª²å ‚äº’å‹•</h1>
            <span id="nav-room-badge" class="hidden bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded border border-indigo-200 font-mono font-bold"></span>
        </div>
        
        <div class="flex items-center gap-2">
            <span id="connection-status" class="text-xs px-2 py-1 rounded bg-gray-200 text-gray-500">é€£ç·šä¸­...</span>
            
            <button id="btn-show-qr" onclick="toggleQRCode()" class="hidden text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-1 rounded flex items-center gap-1 transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4h2v-4zM6 6h6v6H6V6zm12 0h6v6h-6V6zm-6 12h6v6h-6v-6z"></path></svg>
                QR Code
            </button>
            <button id="btn-teacher-login" onclick="promptTeacherLogin()" class="text-gray-400 hover:text-blue-600 text-sm font-medium px-2">
                æ•™å¸«ç™»å…¥
            </button>
        </div>
    </nav>

    <div id="qr-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" onclick="toggleQRCode()">
        <div class="bg-white p-6 rounded-2xl shadow-2xl flex flex-col items-center max-w-sm w-full" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-2 text-gray-800">æƒæåŠ å…¥èª²å ‚</h3>
            <p class="text-gray-500 mb-4 text-sm">è«‹å­¸ç”Ÿä½¿ç”¨ç›¸æ©Ÿæƒæ</p>
            <div id="qrcode-container" class="border-4 border-white shadow-inner bg-gray-50 p-2 rounded-lg"></div>
            <div class="mt-4 text-center">
                <p class="text-sm text-gray-400">æ•™å®¤ä»£ç¢¼</p>
                <p class="text-3xl font-mono font-bold text-indigo-600 tracking-widest" id="qr-room-code">----</p>
            </div>
            <button onclick="toggleQRCode()" class="mt-6 w-full py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-gray-600 font-bold">é—œé–‰</button>
        </div>
    </div>

    <div class="container mx-auto p-4 flex-grow flex flex-col relative max-w-5xl">

        <div id="student-view" class="flex-grow flex flex-col items-center justify-center transition-all duration-300">
            
            <div id="student-login-card" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg border border-gray-100">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold text-gray-800">åŠ å…¥èª²å ‚</h2>
                    <p class="text-gray-500 text-sm mt-1">è«‹è¼¸å…¥ä»£ç¢¼èˆ‡åº§è™Ÿ</p>
                </div>
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">æ•™å®¤ä»£ç¢¼</label>
                        <input type="text" id="join-room-id" class="w-full p-4 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none transition text-center font-mono text-2xl tracking-widest uppercase" placeholder="----" maxlength="4">
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-600 mb-1">æ‚¨çš„åº§è™Ÿ</label>
                        <input type="number" id="join-seat" class="w-full p-3 border-2 border-gray-200 rounded-xl bg-gray-50 focus:bg-white focus:border-indigo-500 outline-none transition text-center text-lg" placeholder="ä¾‹å¦‚: 15">
                    </div>
                    <button onclick="studentJoin()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3.5 rounded-xl shadow-md transition active:scale-95 text-lg">
                        é€²å…¥æ•™å®¤
                    </button>
                </div>
            </div>

            <div id="student-dashboard" class="hidden w-full max-w-3xl space-y-6">
                
                <div id="ai-broadcast-display" class="hidden bg-white p-6 rounded-2xl shadow-lg border-l-4 border-purple-500">
                    <div class="flex items-center gap-2 mb-4 border-b pb-2">
                        <span class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-xs font-bold">AI è€å¸«èªª</span>
                        <span class="text-xs text-gray-400 ml-auto">å³æ™‚åŒæ­¥ä¸­</span>
                    </div>
                    <div id="ai-content-text" class="markdown-body text-gray-800 text-lg leading-relaxed">
                        </div>
                </div>

                <div id="tool-interface" class="hidden bg-white p-6 rounded-2xl shadow-lg border-2 border-indigo-50">
                    <h3 id="tool-header" class="text-lg font-bold text-gray-800 mb-4 text-center">äº’å‹•é¡Œç›®</h3>
                    <div id="tool-form-content" class="mb-6"></div>
                    <button id="student-submit-btn" onclick="submitResponse()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow transition active:scale-95">
                        é€å‡ºç­”æ¡ˆ
                    </button>
                </div>

                <div id="student-waiting" class="text-center py-10">
                    <div class="inline-block p-4 rounded-full bg-gray-100 mb-4 animate-pulse">
                        <svg class="w-12 h-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-600">ç­‰å¾…è€å¸«æŒ‡ä»¤...</h3>
                    <p class="text-gray-400 text-sm mt-2">è«‹æ³¨æ„å‰æ–¹å¤§è¢å¹•æˆ–ç­‰å¾…å…§å®¹æ›´æ–°</p>
                </div>
            </div>
        </div>

        <div id="teacher-view" class="hidden flex-col gap-6">
            
            <div class="bg-white rounded-2xl shadow-lg border border-purple-100 overflow-hidden">
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-4 text-white flex justify-between items-center">
                    <h2 class="font-bold text-lg flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        Gemini AI å»£æ’­ç«™
                    </h2>
                    <span class="text-xs bg-white/20 px-2 py-1 rounded">å­¸ç”Ÿç•«é¢å°‡åŒæ­¥æ›´æ–°</span>
                </div>
                <div class="p-6">
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="ai-prompt" class="flex-grow p-3 border rounded-xl focus:ring-2 focus:ring-purple-500 outline-none" placeholder="è¼¸å…¥æŒ‡ä»¤ï¼šä¾‹å¦‚ã€å‡ºä¸€é¡Œé—œæ–¼ä¸­ç§‹ç¯€çš„è‹±æ–‡é¸æ“‡é¡Œã€...">
                        <button onclick="callGeminiAndBroadcast()" id="btn-ask-gemini" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-6 py-2 rounded-xl transition shadow flex items-center gap-2">
                            <span>âœ¨ ç”Ÿæˆä¸¦å»£æ’­</span>
                        </button>
                    </div>
                    <div class="text-xs text-gray-500 flex gap-2">
                        <button onclick="setPrompt('è«‹å‡ºä¸€å€‹é—œæ–¼ç¾åœ¨å®Œæˆå¼çš„é¸æ“‡é¡Œï¼Œé™„ä¸Šè©³è§£')" class="hover:bg-gray-100 px-2 py-1 rounded border">è‹±æ–‡é¡Œç¯„ä¾‹</button>
                        <button onclick="setPrompt('è«‹ç”¨ç°¡å–®çš„è‹±æ–‡è§£é‡‹ä»€éº¼æ˜¯ SDGs')" class="hover:bg-gray-100 px-2 py-1 rounded border">SDGs ç¯„ä¾‹</button>
                        <button onclick="clearAIContent()" class="ml-auto text-red-500 hover:underline">æ¸…é™¤ç•«é¢</button>
                    </div>
                </div>
            </div>

            <div id="teacher-tools" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div onclick="activateTool('fistFive')" class="tool-card bg-white p-5 rounded-xl border-l-4 border-green-500 shadow-sm">
                    <h3 class="font-bold text-gray-800">ğŸ–ï¸ 1 åˆ° 5 ç†è§£åº¦</h3>
                    <p class="text-xs text-gray-400 mt-1">å¿«é€Ÿèª¿æŸ¥å…¨ç­ç‹€æ³</p>
                </div>
                <div onclick="activateTool('poll')" class="tool-card bg-white p-5 rounded-xl border-l-4 border-blue-500 shadow-sm">
                    <h3 class="font-bold text-gray-800">ğŸ“Š ABCD æŠ•ç¥¨</h3>
                    <p class="text-xs text-gray-400 mt-1">é¸æ“‡é¡Œçµ±è¨ˆ</p>
                </div>
                <div onclick="activateTool('trafficLight')" class="tool-card bg-white p-5 rounded-xl border-l-4 border-red-500 shadow-sm">
                    <h3 class="font-bold text-gray-800">ğŸš¦ ç´…ç¶ ç‡ˆæ±‚åŠ©</h3>
                    <p class="text-xs text-gray-400 mt-1">ä¸æ‡‚è«‹äº®ç´…ç‡ˆ</p>
                </div>
                <div onclick="activateTool('whiteboard')" class="tool-card bg-white p-5 rounded-xl border-l-4 border-yellow-500 shadow-sm">
                    <h3 class="font-bold text-gray-800">ğŸ“ å°ç™½æ¿</h3>
                    <p class="text-xs text-gray-400 mt-1">æ–‡å­—å•ç­”</p>
                </div>
            </div>

            <div id="live-results" class="hidden bg-white rounded-xl shadow-lg border border-gray-200 p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 id="result-title" class="text-xl font-bold text-gray-800">æ´»å‹•çµæœ</h3>
                    <button onclick="stopActivity()" class="text-red-600 hover:bg-red-50 px-3 py-1 rounded border border-red-200 text-sm font-bold">çµæŸæ´»å‹•</button>
                </div>
                <div class="h-64 relative">
                    <canvas id="chartCanvas" class="w-full h-full"></canvas>
                    <div id="chart-empty" class="hidden absolute inset-0 flex items-center justify-center text-gray-400">å°šç„¡æ•¸æ“š</div>
                </div>
                <div id="text-responses" class="mt-4 max-h-60 overflow-y-auto grid grid-cols-2 gap-2"></div>
            </div>
        </div>

    </div>

    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-xs">
            <h3 class="text-lg font-bold mb-4 text-gray-800">æ•™å¸«é©—è­‰</h3>
            <input type="password" id="passcode-input" class="w-full p-3 border rounded-lg mb-4 text-center text-xl tracking-widest" placeholder="è¼¸å…¥ tttt">
            <div class="flex gap-2">
                <button onclick="document.getElementById('login-modal').classList.add('hidden')" class="flex-1 py-2 bg-gray-100 rounded-lg text-gray-600">å–æ¶ˆ</button>
                <button onclick="performTeacherLogin()" class="flex-1 py-2 bg-blue-600 text-white rounded-lg font-bold">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // âš ï¸ è¨­å®šå€ (è«‹å¡«å…¥æ‚¨çš„è³‡æ–™)
        // ==========================================
        
        // 1. å¡«å…¥æ‚¨çš„ Gemini API Key (å» Google AI Studio ç”³è«‹)
        const GEMINI_API_KEY = "AIzaSyAeTm2RBnZ_sE2yLGbZjG2bDnxpM0tq_ak"; 

        // 2. å¡«å…¥ Firebase Config (åŸå°ä¸å‹•æˆ–æ›æˆæ‚¨æ–°çš„)
        const firebaseConfig = {
            apiKey: "AIzaSyDhVIfEev0PhNHlBKL0vAeQy3jwJOsyVFs",
            authDomain: "myassessmenttool.firebaseapp.com",
            projectId: "myassessmenttool",
            storageBucket: "myassessmenttool.firebasestorage.app",
            messagingSenderId: "165443894580",
            appId: "1:165443894580:web:16a2d9731f30fd6e107961"
        };

        // ==========================================
        // ç³»çµ±æ ¸å¿ƒè®Šæ•¸
        // ==========================================
        let db = null;
        let currentRoomId = null;
        let currentRole = 'student';
        let studentSeat = '';
        let unsubscribe = null; // ç”¨ä¾†åœæ­¢ç›£è½
        let chartInstance = null;

        // åˆå§‹åŒ–
        window.onload = function() {
            // åˆå§‹åŒ– Firebase
            if (typeof firebase !== 'undefined' && firebase.apps.length === 0) {
                try {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.firestore();
                    // åŒ¿åç™»å…¥ä»¥å–å¾—æ¬Šé™
                    firebase.auth().signInAnonymously().then(() => {
                        updateStatus('ğŸŸ¢ é›²ç«¯å·²é€£ç·š');
                    }).catch(err => {
                        console.error("Auth Error:", err);
                        updateStatus('ğŸ”´ é€£ç·šå¤±æ•— (è«‹æª¢æŸ¥ Console)');
                    });
                } catch (e) {
                    console.error("Firebase Init Error:", e);
                    updateStatus('ğŸ”´ è¨­å®šæª”éŒ¯èª¤');
                }
            }

            // æª¢æŸ¥ç¶²å€åƒæ•¸ (æ˜¯å¦é€é QR Code é€²å…¥)
            const params = new URLSearchParams(window.location.search);
            const room = params.get('room');
            if (room) {
                document.getElementById('join-room-id').value = room;
            }
        };

        // ==========================================
        // Gemini AI å»£æ’­åŠŸèƒ½ (æ ¸å¿ƒ)
        // ==========================================
        async function callGeminiAndBroadcast() {
            const prompt = document.getElementById('ai-prompt').value;
            if(!prompt) return showToast("è«‹è¼¸å…¥æŒ‡ä»¤", "error");

            const btn = document.getElementById('btn-ask-gemini');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span class="loader"></span> ç”Ÿæˆä¸­...`;
            btn.disabled = true;

            try {
                // 1. å‘¼å« Gemini API
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: "ä½ æ˜¯ä¸€ä½åœ‹ä¸­åŠ©æ•™ã€‚è«‹æ ¹æ“šä»¥ä¸‹è¦æ±‚ç”¢å‡ºå…§å®¹(ä¿æŒç°¡çŸ­ï¼Œé©åˆæŠ•å½±ç‰‡é¡¯ç¤º)ï¼š" + prompt }] }]
                    })
                });
                
                const data = await response.json();
                const aiText = data.candidates[0].content.parts[0].text;

                // 2. å»£æ’­åˆ° Firebase (å¯«å…¥ ai_board æ¬„ä½)
                if(db && currentRoomId) {
                    await db.collection('rooms').doc(currentRoomId).set({
                        aiContent: aiText,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                    showToast("å·²å»£æ’­åˆ°å­¸ç”Ÿå¹³æ¿ï¼", "success");
                } else {
                    showToast("å°šæœªå»ºç«‹æ•™å®¤é€£ç·š", "error");
                }

            } catch (error) {
                console.error(error);
                showToast("AI å‘¼å«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Key", "error");
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function clearAIContent() {
            if(db && currentRoomId) {
                db.collection('rooms').doc(currentRoomId).update({ aiContent: "" });
            }
            document.getElementById('ai-prompt').value = "";
        }

        function setPrompt(text) {
            document.getElementById('ai-prompt').value = text;
        }

        // ==========================================
        // æ•™å¸«ç«¯é‚è¼¯
        // ==========================================
        function promptTeacherLogin() {
            document.getElementById('login-modal').classList.remove('hidden');
        }

        function performTeacherLogin() {
            const pwd = document.getElementById('passcode-input').value;
            if (pwd === 'tttt') { // å¯†ç¢¼
                document.getElementById('login-modal').classList.add('hidden');
                initTeacherMode();
            } else {
                showToast("å¯†ç¢¼éŒ¯èª¤", "error");
            }
        }

        function initTeacherMode() {
            currentRole = 'teacher';
            
            // ç”¢ç”Ÿéš¨æ©Ÿæ•™å®¤ç¢¼
            let rid = sessionStorage.getItem('rid');
            if(!rid) {
                rid = Math.random().toString(36).substring(2,6).toUpperCase();
                sessionStorage.setItem('rid', rid);
            }
            currentRoomId = rid;

            // UI åˆ‡æ›
            document.getElementById('student-view').classList.add('hidden');
            document.getElementById('teacher-view').classList.remove('hidden');
            document.getElementById('teacher-view').classList.add('flex');
            
            document.getElementById('btn-show-qr').classList.remove('hidden');
            document.getElementById('btn-teacher-login').classList.add('hidden');
            
            document.getElementById('nav-room-badge').classList.remove('hidden');
            document.getElementById('nav-room-badge').innerText = `æ•™å®¤: ${rid}`;
            document.getElementById('qr-room-code').innerText = rid;

            showToast(`æ­¡è¿è€å¸«ï¼æ•™å®¤å»ºç«‹æˆåŠŸ ${rid}`, "success");
            
            // åˆå§‹åŒ–è³‡æ–™åº«æ–‡ä»¶
            if(db) {
                db.collection('rooms').doc(rid).set({
                    activeTool: null,
                    aiContent: "",
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                listenForResponses();
            }
        }

        function toggleQRCode() {
            const modal = document.getElementById('qr-modal');
            const container = document.getElementById('qrcode-container');
            
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                container.innerHTML = ""; // æ¸…ç©º
                // ç”¢ç”Ÿç¶²å€ (ç›®å‰çš„ç¶²å€ + ?room=ä»£ç¢¼)
                const url = window.location.href.split('?')[0] + `?room=${currentRoomId}`;
                new QRCode(container, {
                    text: url,
                    width: 200,
                    height: 200
                });
            } else {
                modal.classList.add('hidden');
            }
        }

        function activateTool(toolId) {
            if(!db || !currentRoomId) return;
            
            // æ›´æ–°ç‹€æ…‹è®“å­¸ç”Ÿç«¯åˆ‡æ›
            db.collection('rooms').doc(currentRoomId).update({ activeTool: toolId });
            
            // UI é¡¯ç¤º
            document.getElementById('live-results').classList.remove('hidden');
            document.getElementById('result-title').innerText = toolNames[toolId];
            document.getElementById('text-responses').innerHTML = ''; // æ¸…ç©ºèˆŠå›ç­”
            
            // æ¸…ç©ºåœ–è¡¨
            if(chartInstance) chartInstance.destroy();
            document.getElementById('chartCanvas').classList.add('hidden');
            document.getElementById('chart-empty').classList.remove('hidden');
        }

        function stopActivity() {
            if(db && currentRoomId) {
                db.collection('rooms').doc(currentRoomId).update({ activeTool: null });
            }
            document.getElementById('live-results').classList.add('hidden');
        }

        function listenForResponses() {
            // ç›£è½å­¸ç”Ÿå›ç­” (sub-collection: responses)
            db.collection('rooms').doc(currentRoomId).collection('responses')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot(snapshot => {
                    const data = snapshot.docs.map(d => d.data());
                    updateChart(data);
                });
        }

        // ==========================================
        // å­¸ç”Ÿç«¯é‚è¼¯
        // ==========================================
        function studentJoin() {
            const rid = document.getElementById('join-room-id').value.toUpperCase();
            const seat = document.getElementById('join-seat').value;

            if(rid.length !== 4 || !seat) return showToast("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š", "error");

            currentRoomId = rid;
            studentSeat = seat;

            document.getElementById('student-login-card').classList.add('hidden');
            document.getElementById('student-dashboard').classList.remove('hidden');
            document.getElementById('nav-room-badge').classList.remove('hidden');
            document.getElementById('nav-room-badge').innerText = `åº§è™Ÿ ${seat}`;

            // é–‹å§‹ç›£è½è€å¸«æŒ‡ä»¤ (æ ¸å¿ƒ: onSnapshot)
            if(db) {
                db.collection('rooms').doc(rid).onSnapshot(doc => {
                    if(doc.exists) {
                        const data = doc.data();
                        handleTeacherCommand(data);
                    }
                });
            }
        }

        function handleTeacherCommand(data) {
            // 1. è™•ç† AI å»£æ’­
            const aiArea = document.getElementById('ai-broadcast-display');
            const aiText = document.getElementById('ai-content-text');
            
            if (data.aiContent && data.aiContent.length > 0) {
                aiArea.classList.remove('hidden');
                // ç°¡å–®å°‡æ›è¡Œè½‰ç‚º HTML
                aiText.innerHTML = data.aiContent.replace(/\n/g, '<br>'); 
            } else {
                aiArea.classList.add('hidden');
            }

            // 2. è™•ç†äº’å‹•å·¥å…·
            const toolArea = document.getElementById('tool-interface');
            const waitArea = document.getElementById('student-waiting');

            if (data.activeTool) {
                waitArea.classList.add('hidden');
                toolArea.classList.remove('hidden');
                renderTool(data.activeTool);
            } else {
                toolArea.classList.add('hidden');
                if (!data.aiContent) waitArea.classList.remove('hidden'); // å¦‚æœé€£ AI éƒ½æ²’æœ‰ï¼Œæ‰é¡¯ç¤ºç­‰å¾…
            }
        }

        function submitResponse() {
            const val = getToolValue();
            if(!val) return showToast("è«‹ä½œç­”", "error");

            const btn = document.getElementById('student-submit-btn');
            btn.disabled = true;
            btn.innerText = "å‚³é€ä¸­...";

            // å¯«å…¥ Firestore
            db.collection('rooms').doc(currentRoomId).collection('responses').add({
                seat: studentSeat,
                value: val,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                showToast("é€å‡ºæˆåŠŸ", "success");
                btn.innerText = "å·²é€å‡º";
                setTimeout(() => { btn.disabled = false; btn.innerText = "æ›´æ–°ç­”æ¡ˆ"; }, 2000);
            });
        }

        // ==========================================
        // å·¥å…·æ¸²æŸ“èˆ‡åœ–è¡¨é‚è¼¯ (Helper)
        // ==========================================
        const toolNames = { fistFive: 'ğŸ–ï¸ 1-5 ç†è§£åº¦', poll: 'ğŸ“Š ABCD æŠ•ç¥¨', trafficLight: 'ğŸš¦ ç´…ç¶ ç‡ˆ', whiteboard: 'ğŸ“ å°ç™½æ¿' };
        let currentToolType = '';

        function renderTool(type) {
            currentToolType = type;
            const container = document.getElementById('tool-form-content');
            document.getElementById('tool-header').innerText = toolNames[type];
            
            if(type === 'fistFive') {
                container.innerHTML = `<div class="flex justify-center gap-2">${[1,2,3,4,5].map(n=>`<button onclick="selectOpt(this, '${n}')" class="opt-btn w-12 h-12 border-2 rounded-full font-bold text-gray-500 hover:bg-indigo-50">${n}</button>`).join('')}</div><input type="hidden" id="ans-input">`;
            } else if(type === 'poll') {
                container.innerHTML = `<div class="grid grid-cols-2 gap-4">${['A','B','C','D'].map(o=>`<button onclick="selectOpt(this, '${o}')" class="opt-btn p-4 border-2 rounded-xl text-xl font-bold hover:bg-blue-50">${o}</button>`).join('')}</div><input type="hidden" id="ans-input">`;
            } else if(type === 'trafficLight') {
                container.innerHTML = `<div class="space-y-3"><button onclick="selectOpt(this, 'Green')" class="opt-btn w-full p-4 border-2 border-green-200 bg-green-50 text-green-700 font-bold rounded-xl">ğŸŸ¢ æˆ‘æ‡‚äº†</button><button onclick="selectOpt(this, 'Red')" class="opt-btn w-full p-4 border-2 border-red-200 bg-red-50 text-red-700 font-bold rounded-xl">ğŸ”´ æˆ‘ä¸æ‡‚</button></div><input type="hidden" id="ans-input">`;
            } else { // whiteboard
                container.innerHTML = `<textarea id="ans-input" class="w-full h-32 p-3 border-2 rounded-xl focus:border-indigo-500 outline-none" placeholder="è«‹è¼¸å…¥..."></textarea>`;
            }
        }

        window.selectOpt = (el, val) => {
            document.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('ring-4', 'ring-indigo-300', 'border-indigo-500'));
            el.classList.add('ring-4', 'ring-indigo-300', 'border-indigo-500');
            document.getElementById('ans-input').value = val;
        }

        function getToolValue() {
            return document.getElementById('ans-input').value;
        }

        function updateChart(data) {
            // æ•™å¸«ç«¯åœ–è¡¨æ›´æ–°é‚è¼¯ (ç°¡åŒ–ç‰ˆ)
            const canvas = document.getElementById('chartCanvas');
            const empty = document.getElementById('chart-empty');
            const textContainer = document.getElementById('text-responses');

            // åˆ¤æ–·æ˜¯å¦ç‚ºæ–‡å­—å›æ‡‰
            const isText = data.length > 0 && (data[0].value.length > 5 || currentRole === 'whiteboard');
            
            if (data.length === 0) {
                canvas.classList.add('hidden'); empty.classList.remove('hidden'); return;
            }

            if (isText) {
                canvas.classList.add('hidden'); empty.classList.add('hidden');
                textContainer.innerHTML = data.map(d => `<div class="bg-gray-50 p-2 rounded border"><span class="font-bold text-indigo-600">${d.seat}:</span> ${d.value}</div>`).join('');
            } else {
                // ç¹ªè£½åœ–è¡¨ (Bar Chart)
                canvas.classList.remove('hidden'); empty.classList.add('hidden');
                textContainer.innerHTML = '';
                
                const counts = {};
                data.forEach(d => counts[d.value] = (counts[d.value] || 0) + 1);
                
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(counts),
                        datasets: [{ label: 'äººæ•¸', data: Object.values(counts), backgroundColor: '#4f46e5' }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
        }

        function updateStatus(msg) {
            document.getElementById('connection-status').innerText = msg;
        }

        function showToast(msg, type) {
            const el = document.createElement('div');
            el.className = `p-4 rounded-lg shadow-lg text-white mb-2 text-center ${type==='error'?'bg-red-500':'bg-green-600'}`;
            el.innerText = msg;
            document.getElementById('toast-container').appendChild(el);
            setTimeout(() => el.remove(), 2500);
        }
    </script>
</body>
</html>